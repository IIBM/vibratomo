A51 MACRO ASSEMBLER  RUTIAS                                                               05/05/2014 01:05:54 PAGE     1


MACRO ASSEMBLER A51 V8.02b
OBJECT MODULE PLACED IN rutias.OBJ
ASSEMBLER INVOKED BY: C:\Program Files (x86)\keil\C51\BIN\A51.EXE rutias.asm SET(SMALL) DEBUG EP

LOC  OBJ            LINE     SOURCE

                       1     PUBLIC PASO                                             ;PARA QUE LAS PUEDA VER DESDE C
                       2     PUBLIC DELAY_SLEEP
                       3     PUBLIC AVANZAR
                       4     PUBLIC RETROCEDER
                       5     PUBLIC DELAY_PASOS
                       6     PUBLIC AVANZAR_1_PASOM
                       7     PUBLIC AVANZAR_1mm
                       8     PUBLIC PRENDER
                       9     PUBLIC APAGAR
                      10     PUBLIC ERROR
                      11     PUBLIC RETROCEDER_1mm
                      12     
                      13     
                      14     ;24 pasos del motor son 1,008 mm
                      15     ;si 1/32 pasos hace el DRV entonces 768 pasos DRV son 1,008mm
                      16     ; DELAY_PASOS = 1/ (768 * velocidad) donde velocidad son mm/seg
                      17     
  0090                18     STEP                    equ     P1.0    ;etiqueto al puerto con el nombre. 
  0091                19     RESET                   equ     P1.1
  0092                20     DIR                             equ     p1.2
  0093                21     SLEEP                   equ     P1.3
  0094                22     FAUL                    equ     P1.4
  0095                23     HOME                    equ     P1.5
  00FA                24     RETRASO_SUP             equ     250             ;sale de hacer (65536- retardo deseado) + 6
                              donde 65536 es el numero maxio del temporizador con 16 bit y 6 el tiempo para setear las variables
  00EC                25     RETRASO_INF             equ 236         ;retraso sup son los primero 8 bit y el inf son los
                              ultimos 8 
  00FF                26     RETRASO_SUP_R   equ     255             ;retraso superior e inferior para el retorceso, sal
                             e de hacer la misma cuenta que antes
  002D                27     RETRASO_INF_R   equ 45          ; la velocidad es de 6mm/seg
                      28     
                      29     
----                  30     cseg at 0x0100
                      31     
0100                  32     PRENDER:
0100 D293             33                             SETB SLEEP
0102 22               34                             RET
                      35     
0103                  36     ERROR:
0103 A294             37                             MOV C,FAUL
0105 22               38                             RET
                      39                     
                      40     
0106                  41     APAGAR:
0106 C293             42                             CLR SLEEP
0108 22               43                             RET
                      44     
0109                  45     DELAY_PASOS_R:                                          ;retardo para el retroceso
0109 758901           46                             MOV TMOD, #01H
010C 758CFF           47                             MOV TH0,#RETRASO_SUP_R
010F 758A2D           48                             MOV TL0,#RETRASO_INF_R
0112 D28C             49                             SETB TR0
0114 AE8C             50             CICLO3: mov R6,TH0
0116 AD8A             51                             mov R5,TL0
0118 308DF9           52                             JNB TF0,CICLO3
011B C28D             53                             CLR TF0
011D 22               54                             RET
                      55                     
A51 MACRO ASSEMBLER  RUTIAS                                                               05/05/2014 01:05:54 PAGE     2

                      56                     
011E                  57     DELAY_SLEEP:                    ;es un delay de 1.7ms. Es el tiempo que necesita DRV desde 
                             que se lo saca de modo sleep hasta que se le mande la señal para hacer un paso.
011E 758901           58                             MOV TMOD,#01H
0121 758CF9           59                             MOV TH0,#249
0124 758A62           60                             MOV TL0,#98
0127 D28C             61                             SETB TR0
0129 308DFD           62             CICLO:  JNB TF0,CICLO
012C C28D             63                             CLR TF0
012E 22               64                             RET
                      65     
                      66     ;                       MOV R1,#100
                      67     ;       LAZO3:  MOV R2,#7 ;
                      68     ;       LAZO4:  DJNZ R2,LAZO4
                      69     ;                       DJNZ R1,LAZO3
                      70     ;                       RET
                      71                             
012F                  72     AVANZAR:
012F D292             73                             SETB DIR ;DIR=1 avanza
0131 22               74                             RET     
                      75                             
0132                  76     DELAY_PASOS:                    ; es un delay de 1.3ms
0132 758901           77                             MOV TMOD, #01H
0135 758CFA           78                             MOV TH0,#RETRASO_SUP
0138 758AEC           79                             MOV TL0,#RETRASO_INF
013B D28C             80                             SETB TR0
013D 308DFD           81             CICLO2: JNB TF0,CICLO2
0140 C28D             82                             CLR TF0
0142 22               83                             RET
                      84     
                      85     ;                       MOV R1,#3
                      86     ;       LAZO5:  MOV R2,#215
                      87     ;       LAZO6:  DJNZ R2,LAZO6
                      88     ;                       DJNZ R1,LAZO5
                      89     ;                       RET
                      90     
                      91     
0143                  92     PASO:                                   ; manda una señal de '1' y '0' para que el DRV haga
                              1/32 paso
0143 D290             93                             SETB    STEP
0145 00               94                             NOP
0146 C290             95                             CLR             STEP
0148 00               96                             NOP
0149 22               97                             RET
                      98                             ;La señal debe permanecer en alto y bajo 2us por estado para que fu
                             ncione el DRV
                      99                             
014A                 100     AVANZAR_1_PASOM:                                ;hace un paso completo del motor
014A 7920            101                             MOV R1,#32
014C 3143            102             FALTA:  CALL PASO               
014E 3132            103                             CALL DELAY_PASOS        ;espera entre micropaso y micropaso
0150 D9FA            104                             DJNZ R1,FALTA
0152 22              105                             RET
                     106                             
0153                 107     AVANZAR_1mm:                            ;avanza 1 mm
0153 7A18            108                             MOV R2,#24
0155 314A            109             FALTA2: CALL AVANZAR_1_PASOM
0157 DAFC            110                             DJNZ R2,FALTA2
0159 22              111                             RET
                     112                             
015A                 113     RETROCEDER_1_PASOM:                             ;hace un paso completo del motor
015A 7920            114                             MOV R1,#32
015C 3143            115             FALTA3: CALL PASO               
015E 3109            116                             CALL DELAY_PASOS_R      ;espera entre micropaso y micropaso
0160 D9FA            117                             DJNZ R1,FALTA3
0162 22              118                             RET
A51 MACRO ASSEMBLER  RUTIAS                                                               05/05/2014 01:05:54 PAGE     3

                     119                             
0163                 120     RETROCEDER_1mm:                         ;avanza 1 mm
0163 7A18            121                             MOV R2,#24
0165 315A            122             FALTA4: CALL RETROCEDER_1_PASOM
0167 DAFC            123                             DJNZ R2,FALTA4
0169 22              124                             RET
                     125     
016A                 126     RETROCEDER:
016A C292            127                             CLR DIR
016C 22              128                             RET
                     129     
                     130     
                     131             
                     132     end
A51 MACRO ASSEMBLER  RUTIAS                                                               05/05/2014 01:05:54 PAGE     4

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

APAGAR . . . . . .  C ADDR   0106H   A   
AVANZAR. . . . . .  C ADDR   012FH   A   
AVANZAR_1MM. . . .  C ADDR   0153H   A   
AVANZAR_1_PASOM. .  C ADDR   014AH   A   
CICLO. . . . . . .  C ADDR   0129H   A   
CICLO2 . . . . . .  C ADDR   013DH   A   
CICLO3 . . . . . .  C ADDR   0114H   A   
DELAY_PASOS. . . .  C ADDR   0132H   A   
DELAY_PASOS_R. . .  C ADDR   0109H   A   
DELAY_SLEEP. . . .  C ADDR   011EH   A   
DIR. . . . . . . .  B ADDR   0090H.2 A   
ERROR. . . . . . .  C ADDR   0103H   A   
FALTA. . . . . . .  C ADDR   014CH   A   
FALTA2 . . . . . .  C ADDR   0155H   A   
FALTA3 . . . . . .  C ADDR   015CH   A   
FALTA4 . . . . . .  C ADDR   0165H   A   
FAUL . . . . . . .  B ADDR   0090H.4 A   
HOME . . . . . . .  B ADDR   0090H.5 A   
P1 . . . . . . . .  D ADDR   0090H   A   
PASO . . . . . . .  C ADDR   0143H   A   
PRENDER. . . . . .  C ADDR   0100H   A   
RESET. . . . . . .  B ADDR   0090H.1 A   
RETRASO_INF. . . .  N NUMB   00ECH   A   
RETRASO_INF_R. . .  N NUMB   002DH   A   
RETRASO_SUP. . . .  N NUMB   00FAH   A   
RETRASO_SUP_R. . .  N NUMB   00FFH   A   
RETROCEDER . . . .  C ADDR   016AH   A   
RETROCEDER_1MM . .  C ADDR   0163H   A   
RETROCEDER_1_PASOM  C ADDR   015AH   A   
SLEEP. . . . . . .  B ADDR   0090H.3 A   
STEP . . . . . . .  B ADDR   0090H.0 A   
TF0. . . . . . . .  B ADDR   0088H.5 A   
TH0. . . . . . . .  D ADDR   008CH   A   
TL0. . . . . . . .  D ADDR   008AH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
